<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>TUCAN WebDemo Prototype</title>
    <link rel="shortcut icon" href="/favicon.ico" sizes="32x32">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.21.2/full/pyodide.js" integrity="sha384-YVjw/1HYxhS/IrWnHk53COddbuHAOr+egsllNx1PP0ZlqSgfzUCrpZYC3fE7GHU7" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/openchemlib@8.0.1/dist/openchemlib-full.js" integrity="sha384-RxvJ2Cxtvbxis7bjN+Q4x6PGlzQX7ff7A5p5YP/9u/GK3zgFPPXzmZHVUfTxC1QN" crossorigin="anonymous"></script>
    <style>
      .row {
        display: flex;
      }
      .column {
        flex: 50%;
      }
    </style>
  </head>
  <body onload="onBodyload()">
    <script>
      function onBodyload() {
        startEditor();
        writeOutputText("Loading Pyodide and the TUCAN package. This may take a few seconds ...");
      }

      var editor;

      function startEditor() {
        editor = window.OCL.StructureEditor.createSVGEditor("editor", 1);
      }

      function getMolfileFromEditor() {
        let origMol = editor.getMolecule();
        let molecule = new OCL.Molecule(origMol.getAllAtoms(), origMol.getAllBonds());
        origMol.copyMolecule(molecule);
        molecule.addImplicitHydrogens();
        return molecule.toMolfileV3();
      }

      async function startPyodide() {
        let pyodide = await loadPyodide();
        await pyodide.loadPackage("micropip");
        const micropip = pyodide.pyimport("micropip");
        await micropip.install("texttable");

        let packages = [
          "networkx",
          "dist/igraph-0.9.11-cp310-cp310-emscripten_3_1_14_wasm32.whl",
          "dist/tucan-0.1.0-py2.py3-none-any.whl"
        ];
        await pyodide.loadPackage(packages);

        console.log("Pyodide is ready!");
        return pyodide;
      }
      var pyodidePromise = startPyodide();

      async function loadTucanwebPy() {
        let [pyodide, code] = await Promise.all([pyodidePromise, (await fetch("tucanweb.py")).text()]);
        return pyodide.runPythonAsync(code);
      }
      var molfile_to_tucanPromise = loadTucanwebPy();

      function reloadTucanwebPy() {
        molfile_to_tucanPromise = loadTucanwebPy();
      }

      function onFinishLoad() {
        document.getElementById("btnConvertEditor").disabled = false;
        document.getElementById("btnConvertMolfile").disabled = false;
        writeOutputText("Python environment was loaded. Have fun with TUCAN!");
      }

      async function convertToTucan(molfile) {
        let molfile_to_tucan = await molfile_to_tucanPromise;
        try {
          let tucan = molfile_to_tucan(molfile);
          writeOutputText(tucan);
        } catch (e) {
          console.log(e);
          writeOutputText("An error occured during the serialization to TUCAN. This might be due to an incorrect V3000 Molfile. Check your browser console (F12) for details.");
        }
      }

      function writeOutputText(text) {
        document.getElementById("outputtext").innerHTML = text;
      }

      molfile_to_tucanPromise.then(() => onFinishLoad());
    </script>

    <noscript>You need to enable JavaScript!</noscript>
    <div class="row">
      <div class="column">
        <div id="editor" style="width:400px;height:400px;border:solid;border-width:1px;"></div>
        <div>
          <button id="btnConvertEditor" onclick="convertToTucan(getMolfileFromEditor())" disabled="true">Convert molecule in editor to TUCAN</button>
        </div>
      </div>
      <div class="column">
        <div>
          <textarea id="textarea" style="height:400px;width:75%;resize:none;" placeholder="Molfile V3000"></textarea>
        </div>
        <div>
          <button id="btnConvertMolfile" onclick="convertToTucan(document.getElementById('textarea').value)" disabled="true">Convert Molfile in text field to TUCAN</button>
        </div>
      </div>
    </div>
    <pre id="outputtext" style="white-space: pre-wrap;user-select: all;"></pre>
  </body>
</html>