<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TUCAN WebDemo Prototype</title>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" sizes="32x32">
    <script src="https://cdn.jsdelivr.net/pyodide/v0.21.2/full/pyodide.js" integrity="sha384-YVjw/1HYxhS/IrWnHk53COddbuHAOr+egsllNx1PP0ZlqSgfzUCrpZYC3fE7GHU7" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/openchemlib@8.0.1/dist/openchemlib-full.js" integrity="sha384-RxvJ2Cxtvbxis7bjN+Q4x6PGlzQX7ff7A5p5YP/9u/GK3zgFPPXzmZHVUfTxC1QN" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css" integrity="sha384-xeJqLiuOvjUBq3iGOjvSQSIlwrpqjSHXpduPd6rQpuiM3f5/ijby8pCsnbu5S81n" crossorigin="anonymous">
  </head>
  <body onload="onBodyload()">
    <script>
      function onBodyload() {
        startEditor();
        writeOutputText("Loading Pyodide and the TUCAN package. This may take a few seconds ...");
      }

      var editor;

      function startEditor() {
        editor = window.OCL.StructureEditor.createSVGEditor("editor", 1);
      }

      function getMolfileFromEditor() {
        let origMol = editor.getMolecule();
        let molecule = new OCL.Molecule(origMol.getAllAtoms(), origMol.getAllBonds());
        origMol.copyMolecule(molecule);
        molecule.addImplicitHydrogens();
        return molecule.toMolfileV3();
      }

      async function startPyodide() {
        let pyodide = await loadPyodide();
        await pyodide.loadPackage("micropip");
        const micropip = pyodide.pyimport("micropip");
        await micropip.install("texttable");

        let packages = [
          "networkx",
          "dist/igraph-0.9.11-cp310-cp310-emscripten_3_1_14_wasm32.whl",
          "dist/tucan-0.1.0-py2.py3-none-any.whl"
        ];
        await pyodide.loadPackage(packages);

        console.log("Pyodide is ready!");
        return pyodide;
      }
      var pyodidePromise = startPyodide();

      async function loadTucanwebPy() {
        let [pyodide, code] = await Promise.all([pyodidePromise, (await fetch("tucanweb.py")).text()]);
        return pyodide.runPythonAsync(code);
      }
      var molfile_to_tucanPromise = loadTucanwebPy();

      function reloadTucanwebPy() {
        molfile_to_tucanPromise = loadTucanwebPy();
      }

      function onFinishLoad() {
        document.getElementById("btnConvertEditor").disabled = false;
        document.getElementById("btnConvertMolfile").disabled = false;
        writeOutputText("Python environment was loaded. Have fun with TUCAN!");
      }

      async function convertToTucan(molfile) {
        let molfile_to_tucan = await molfile_to_tucanPromise;
        try {
          let tucan = molfile_to_tucan(molfile);
          writeOutputText(tucan);
        } catch (e) {
          console.error(e);
          writeOutputText("An error occured during the serialization to TUCAN. This might be due to an incorrect V3000 Molfile. Check your browser console (F12) for details.");
        }
      }

      function writeOutputText(text) {
        document.getElementById("outputtext").innerHTML = text;
      }

      molfile_to_tucanPromise.then(() => onFinishLoad());
    </script>

    <div class="container mb-5">
      <noscript>You need to enable JavaScript!</noscript>
      <h1 class="mt-4">Convert Molfile V3000 to TUCAN</h1>
      <div class="row mt-3 mb-3">
        <div class="col-lg-6">
          <div id="editor" style="width:400px;height:400px;border:solid;border-width:1px;border-color:#ced4da;border-radius:.375rem"></div>
        </div>
        <div class="col-lg-6">
          <div style="display:inline-block;position:relative;">
            <textarea id="textarea" class="form-control" style="height:400px;width:470px;resize:none;" placeholder="Molfile V3000"></textarea>
            <button class="btn btn-outline-secondary border-0" style="position:absolute;top:10px;right:10px;" onclick="document.getElementById('textarea').value = ''"><i class="bi bi-trash"></i></button>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-6">
          <button id="btnConvertEditor" class="btn btn-outline-secondary" onclick="convertToTucan(getMolfileFromEditor())" disabled="true">Convert molecule in editor to TUCAN</button>
        </div>
        <div class="col-lg-6">
          <button id="btnConvertMolfile" class="btn btn-outline-secondary" onclick="convertToTucan(document.getElementById('textarea').value)" disabled="true">Convert Molfile in text field to TUCAN</button>
        </div>
      </div>
      <div class="row mt-3">
        <pre id="outputtext" style="white-space:pre-wrap;user-select:all;"></pre>
      </div>
    </div>
    <footer class="footer mt-auto py-3 bg-light" style="position:fixed;bottom:0;text-align:center;width:100%;">
      <div style="container">
        <a href="https://github.com/TUCAN-nest/TUCAN" target="_blank" class="link-secondary me-3">TUCAN GitHub Project</a>
        <a href="https://github.com/TUCAN-nest/TUCAN/issues" target="_blank" class="link-secondary">Issues</a>
      </div>
    </footer>
  </body>
</html>