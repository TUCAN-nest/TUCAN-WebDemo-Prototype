<html>
  <head>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.21.1/full/pyodide.js"></script>
    <script src="https://unpkg.com/openchemlib@8.0.1/dist/openchemlib-full.js"></script>
    <style>
      .row {
        display: flex;
      }
      .column {
        flex: 50%;
      }
    </style>
  </head>
  <body onload="startEditor()">
    <script type="text/javascript">
      var editor;

      function startEditor() {
        editor = window.OCL.StructureEditor.createSVGEditor("editor", 1);
      }

      function getMolfileFromEditor() {
        let origMol = editor.getMolecule();
        let molecule = new OCL.Molecule(origMol.getAllAtoms(), origMol.getAllBonds());
        origMol.copyMolecule(molecule);
        molecule.addImplicitHydrogens();
        return molecule.toMolfileV3();
      }

      async function startPyodide() {
        let pyodide = await loadPyodide();
        await pyodide.loadPackage("micropip");
        const micropip = pyodide.pyimport("micropip");
        await micropip.install("texttable");

        let packages = [
          "networkx",
          "http://127.0.0.1:8000/dist/igraph-0.9.11-cp310-cp310-emscripten_3_1_14_wasm32.whl",
          "http://127.0.0.1:8000/dist/tucan-0.1.0-py2.py3-none-any.whl"
        ];
        await pyodide.loadPackage(packages);

        console.log("Pyodide is ready!");
        return pyodide;
      }
      var pyodidePromise = startPyodide();

      async function loadTucanwebPy() {
        let pyodide = await pyodidePromise;
        return pyodide.runPython(await (await fetch("tucanweb.py")).text());
      }
      var molfile_to_tucanPromise = loadTucanwebPy();

      function reloadTucanwebPy() {
        molfile_to_tucanPromise = loadTucanwebPy();
      }

      async function convertToTucan(molfile) {
        let molfile_to_tucan = await molfile_to_tucanPromise;
        let tucan = molfile_to_tucan(molfile);
        document.getElementById("tucantext").innerHTML = tucan;
      }
    </script>

    <div class="row">
      <div class="column">
        <div id="editor" style="width:400px;height:400px;border:solid;border-width:1px;"></div>
        <button onclick="convertToTucan(getMolfileFromEditor())">Convert molecule in editor to TUCAN</button>
      </div>
      <div class="column">
        <textarea id="textarea" style="height:400px;width:75%;" placeholder="Molfile V3000"></textarea>
        <button onclick="convertToTucan(document.getElementById('textarea').value)">Convert Molfile in text field to TUCAN</button>
      </div>
    </div>
    <pre id="tucantext" style="white-space: pre-wrap;"></pre>
  </body>
</html>